<?php $this->addJs('/plugins/demo/core/controllers/javascriptlibrarycontroller/assets/js/engine.js') ?>
<?php $this->addCss('/plugins/demo/report/controllers/dashboardcontroller/assets/css/gridstack.min.css') ?>
<?php $this->addJs('/plugins/demo/report/controllers/dashboardcontroller/assets/js/gridstack.all.js') ?>
<?php $this->addJs('/plugins/demo/report/controllers/dashboardcontroller/assets/js/dashboard.data.js') ?>
<?php $this->addJs('/plugins/demo/report/controllers/widgetcontroller/assets/js/widget.data.js') ?>
<?php if ($preview === true) { ?>
    <a href="../render-dashboard/<?= $dashboard->slug ?>" style="margin: 0;auto;">View</a>
<?php } ?>
<div id="dashboard-container-<?= $dashboard->id ?>" style="height: 100%;width: 100%;" class="dashboard-container">
    <div class="grid-stack">
        <?php
        foreach ($dashboard->config_widgets as $config) {
            ?>
            <div class="grid-stack-item" data-gs-x="<?= $config['x'] ?>" data-gs-y="<?= $config['y'] ?>"
                 data-gs-width="<?= $config['width'] ?>" data-gs-height="<?= $config['height'] ?>">
                <div class="grid-stack-item-content">
                    <?php
                    $widgetController = new \Demo\Report\Controllers\WidgetController();
                    $widget = \Demo\Report\Models\Widget::where('id', $config['widget'])->first();
                    $widgetController->addAssets($this, $widget);
                    ?>
                    <?= $widgetController->renderWidget($widget) ?>
                </div>
            </div>

            <?php
        }
        ?>
    </div>
</div>
<div id="ReportContainer-container-toolbar" class="dashboard-toolbar">
    <div class="dropdown dropup">
        <a href="javascript:;" class="manage-widgets" data-toggle="dropdown">
            <i class="icon-cogs"></i> Manage widgets </a>

        <ul class="dropdown-menu" role="menu" data-dropdown-title="Manage dashboard">
            <li role="presentation">
                <a role="menuitem" href="javascript:;" data-control="popup"
                   data-handler="onLoadAddPopup" class="oc-icon-plus" tabindex="-1">
                    Add widget </a>
            </li>
            <li role="separator" class="divider"></li>
            <li role="presentation">
                <a role="menuitem" href="javascript:;" class="oc-icon-floppy-o save-dashboard"
                   data-hotkey="ctrl+enter, cmd+enter">
                    Save </a>
            </li>
            <li role="presentation">
                <a role="menuitem" href="javascript:;"
                   data-request-success="$(window).trigger('oc.reportWidgetRefresh')"
                   data-request="onResetWidgets" data-request-confirm="Reset layout back to default?"
                   class="oc-icon-repeat" tabindex="-1">
                    Reset layout </a>
            </li>
        </ul>
    </div>
</div>
<style>
    .grid-stack {
        width: 100%;
        height: 100%;
    }

    .dashboard-toolbar {
        position: absolute;
        bottom: 2px;
    }

    .dashboard-toolbar .manage-widgets {
        display: inline-block;
        color: #bcc3c7;
        padding: 10px 15px;
        font-size: 14px;
        font-weight: 400;
        border: 1px dashed #bcc3c7;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px;
        margin-left: 5px;
    }

    .close-widget {
        cursor: pointer;
        z-index: 9999;
    }

    .grid-stack > .grid-stack-item > .grid-stack-item-content {
        overflow: hidden;
        background-color: white;
        /*padding: 10px 10px 10px 10px;*/
        box-shadow: 0 8px 16px -8px rgba(0, 0, 0, 0.4);
        margin: 5px 5px 5px 5px;
    }

    .grid-stack > .grid-stack-item > .ui-resizable-se, .grid-stack > .grid-stack-item > .ui-resizable-sw {
        background-image: none;
    }
</style>
<script>
    var dashboard = new Dashboard('<?= $dashboard->id ?>');
    dashboard.render();
    $('.dashboard-toolbar .save-dashboard').click(function () {
        dashboard.save();
    });
</script>
